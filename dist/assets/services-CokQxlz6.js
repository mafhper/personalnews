function Be(s){const e={articles:new Map,titleIndex:new Map,contentIndex:new Map,categoryIndex:new Map,sourceIndex:new Map,lastUpdated:Date.now()};return s.forEach((t,r)=>{const n=`${t.link}-${r}`;e.articles.set(n,t),v(t.title).forEach(i=>{e.titleIndex.has(i)||e.titleIndex.set(i,[]),e.titleIndex.get(i).push(n)}),t.description&&v(t.description).forEach(d=>{e.contentIndex.has(d)||e.contentIndex.set(d,[]),e.contentIndex.get(d).push(n)}),t.categories&&t.categories.forEach(i=>{v(i).forEach(c=>{e.categoryIndex.has(c)||e.categoryIndex.set(c,[]),e.categoryIndex.get(c).push(n)})}),v(t.sourceTitle).forEach(i=>{e.sourceIndex.has(i)||e.sourceIndex.set(i,[]),e.sourceIndex.get(i).push(n)})}),e}function v(s){return s.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>2)}function Ue(s,e,t={}){const{includeTitle:r=!0,includeContent:n=!0,includeCategories:o=!0,includeSource:a=!0,fuzzyThreshold:i=.6}=t;if(!e.trim())return[];const d=v(e),c=new Map;d.forEach(u=>{r&&C(s.titleIndex,u,i,c,"title",3),n&&C(s.contentIndex,u,i,c,"content",1),o&&C(s.categoryIndex,u,i,c,"category",2),a&&C(s.sourceIndex,u,i,c,"source",1.5)});const h=[];return c.forEach((u,b)=>{const E=s.articles.get(b);E&&h.push({article:E,score:u.score,matchedFields:Array.from(u.matchedFields)})}),h.sort((u,b)=>b.score-u.score)}function C(s,e,t,r,n,o){s.forEach((a,i)=>{const d=ae(e,i);if(d>=t){const c=d*o;a.forEach(h=>{r.has(h)||r.set(h,{score:0,matchedFields:new Set});const u=r.get(h);u.score+=c,u.matchedFields.add(n)})}})}function ae(s,e){if(s===e)return 1;if(s.includes(e)||e.includes(s))return .9;const t=Math.max(s.length,e.length);return t===0?1:1-ie(s,e)/t}function ie(s,e){const t=Array(e.length+1).fill(null).map(()=>Array(s.length+1).fill(null));for(let r=0;r<=s.length;r++)t[0][r]=r;for(let r=0;r<=e.length;r++)t[r][0]=r;for(let r=1;r<=e.length;r++)for(let n=1;n<=s.length;n++){const o=s[n-1]===e[r-1]?0:1;t[r][n]=Math.min(t[r][n-1]+1,t[r-1][n]+1,t[r-1][n-1]+o)}return t[e.length][s.length]}function ke(s,e){if(!e.trim())return s;const t=e.trim().split(/\s+/);let r=s;return t.forEach(n=>{const o=ce(n),a=new RegExp(`(${o})`,"gi");r=r.replace(a,"<mark>$1</mark>")}),r}function ce(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const l=s=>{const e=s.replace("#","");if(!/^[a-fA-F0-9]{3}$|^[a-fA-F0-9]{6}$/.test(e))throw new Error(`Invalid hex color format: ${s}. Expected format: #RRGGBB or #RGB`);let t,r,n;if(e.length===3?(t=parseInt(e[0]+e[0],16),r=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16)):(t=parseInt(e.substring(0,2),16),r=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16)),isNaN(t)||isNaN(r)||isNaN(n)||t<0||t>255||r<0||r>255||n<0||n>255)throw new Error(`Invalid hex color conversion result: ${s} -> ${t} ${r} ${n}`);return`${t} ${r} ${n}`},F=[{id:"noite-urbana",name:"Noite Urbana",description:"Tema escuro urbano com azul médio e acentos âmbar",category:"dark",theme:{id:"noite-urbana",name:"Noite Urbana",colors:{primary:"18 102 204",secondary:l("#1E1E1E"),accent:"138 101 8",background:l("#121212"),surface:l("#1E1E1E"),text:l("#FFFFFF"),textSecondary:l("#B0B0B0"),border:"75 85 99",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},{id:"verde-noturno",name:"Verde Noturno",description:"Tema escuro com verde natural e acentos solares",category:"dark",theme:{id:"verde-noturno",name:"Verde Noturno",colors:{primary:"52 125 54",secondary:l("#1B1F1D"),accent:"122 105 17",background:l("#0D0D0D"),surface:l("#1B1F1D"),text:l("#F1F1F1"),textSecondary:l("#A8A8A8"),border:"75 85 99",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},{id:"roxo-nebuloso",name:"Roxo Nebuloso",description:"Tema escuro místico com roxo vibrante e rosa neon",category:"dark",theme:{id:"roxo-nebuloso",name:"Roxo Nebuloso",colors:{primary:"173 46 207",secondary:l("#1A1A23"),accent:"204 51 102",background:l("#101014"),surface:l("#1A1A23"),text:l("#E0E0E0"),textSecondary:l("#9C9C9C"),border:"75 85 99",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},{id:"solar-clean",name:"Solar Clean",description:"Tema claro limpo com azul clássico e laranja queimado",category:"light",theme:{id:"solar-clean",name:"Solar Clean",colors:{primary:l("#1976D2"),secondary:l("#F5F5F5"),accent:"184 61 23",background:l("#FFFFFF"),surface:l("#F5F5F5"),text:l("#212121"),textSecondary:l("#616161"),border:"156 163 175",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},{id:"verao-pastel",name:"Verão Pastel",description:"Tema claro pastel com rosa vibrante e lilás suave",category:"light",theme:{id:"verao-pastel",name:"Verão Pastel",colors:{primary:"178 48 92",secondary:l("#FFFFFF"),accent:l("#7E57C2"),background:l("#FFF8F0"),surface:l("#FFFFFF"),text:l("#212121"),textSecondary:"97 97 97",border:"156 163 175",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},{id:"minimal-ice",name:"Minimal Ice",description:"Tema claro minimalista com ciano frio e coral quente",category:"light",theme:{id:"minimal-ice",name:"Minimal Ice",colors:{primary:"0 129 145",secondary:l("#FFFFFF"),accent:"184 81 49",background:l("#F0F4F8"),surface:l("#FFFFFF"),text:l("#1C1C1C"),textSecondary:l("#5E5E5E"),border:"156 163 175",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}}],je={currentTheme:F.find(s=>s.id==="solar-clean")?.theme||F[0].theme,customThemes:[],autoDetectSystemTheme:!0,systemThemeOverride:null,themeTransitions:!0},le=s=>{const e=["id","name","colors","layout","density","borderRadius"],t=["primary","secondary","accent","background","surface","text","textSecondary","border","success","warning","error"];for(const r of e)if(!(r in s))return console.warn(`Theme validation failed: missing field "${r}"`),!1;if(s.colors){for(const r of t)if(!(r in s.colors))return console.warn(`Theme validation failed: missing color "${r}"`),!1}if(s.colors){for(const[r,n]of Object.entries(s.colors))if(!de(n))return console.warn(`Theme validation failed: invalid RGB format for color "${r}": "${n}"`),!1}return!0},de=s=>/^\d{1,3}\s+\d{1,3}\s+\d{1,3}$/.test(s)?s.split(/\s+/).map(Number).every(r=>r>=0&&r<=255):!1,We=(s,e="1.0")=>{try{if(typeof s=="string")return O(s,"Migrated Theme");if(le(s))return s;if(s.colors?.accent||s.accent){const t=s.colors?.accent||s.accent;return O(t,s.name||"Migrated Theme")}return null}catch(t){return console.error("Theme migration failed:",t),null}},O=(s,e)=>{const t=s.split(/\s+/).map(Number),[r,n,o]=t,a=r*.299+n*.587+o*.114<128;return{id:`custom-${Date.now()}`,name:e,colors:{primary:s,secondary:a?"45 55 72":"229 231 235",accent:s,background:a?"26 32 44":"255 255 255",surface:a?"45 55 72":"249 250 251",text:a?"247 250 252":"17 24 39",textSecondary:a?"160 174 192":"107 114 128",border:a?"75 85 99":"209 213 219",success:"16 185 129",warning:"245 158 11",error:"239 68 68"},layout:"comfortable",density:"medium",borderRadius:"medium",shadows:!0,animations:!0}},_e=s=>{const e=document.documentElement;Object.entries(s.colors).forEach(([i,d])=>{e.style.setProperty(`--color-${i}`,d)});const r={compact:{padding:"0.5rem",gap:"0.5rem"},comfortable:{padding:"1rem",gap:"1rem"},spacious:{padding:"1.5rem",gap:"1.5rem"}}[s.layout];e.style.setProperty("--layout-padding",r.padding),e.style.setProperty("--layout-gap",r.gap);const o={low:{fontSize:"0.875rem",lineHeight:"1.25rem"},medium:{fontSize:"1rem",lineHeight:"1.5rem"},high:{fontSize:"1.125rem",lineHeight:"1.75rem"}}[s.density];e.style.setProperty("--density-font-size",o.fontSize),e.style.setProperty("--density-line-height",o.lineHeight);const a={none:"0",small:"0.25rem",medium:"0.5rem",large:"1rem"};e.style.setProperty("--border-radius",a[s.borderRadius]),e.style.setProperty("--shadows-enabled",s.shadows?"1":"0"),e.style.setProperty("--animations-enabled",s.animations?"1":"0"),e.style.setProperty("--transition-duration",s.animations?"0.2s":"0s")},Oe=()=>typeof window<"u"&&window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"dark",Xe=s=>{const e=F.filter(t=>t.category===s||s==="dark"&&t.category==="colorful");return e.length>0?e[0].theme:F[0].theme},X={log:s=>{}},me={maxSize:500,maxAge:1440*60*1e3,memoryLimit:50,autoCleanupInterval:300*1e3};class he{constructor(e={}){this.options={...me,...e},this.cache=new Map,this.stats={hits:0,misses:0,evictions:0},this.cleanupInterval=null,this.options.autoCleanupInterval>0&&this.startAutoCleanup()}getKey(e){return`${e.link}|${e.sourceTitle}`}get(e,t){let r;if(typeof e=="string"&&t)r=`${e}|${t}`;else if(typeof e=="object")r=this.getKey(e);else throw new Error("Invalid arguments to get()");const n=this.cache.get(r);return n?(this.cache.delete(r),this.cache.set(r,{article:n.article,timestamp:n.timestamp}),this.stats.hits++,n.article):(this.stats.misses++,null)}set(e){const t=this.getKey(e);this.cache.delete(t),this.cache.set(t,{article:e,timestamp:Date.now()}),this.enforceConstraints()}setMany(e){e.forEach(t=>this.set(t))}has(e,t){let r;if(typeof e=="string"&&t)r=`${e}|${t}`;else if(typeof e=="object")r=this.getKey(e);else throw new Error("Invalid arguments to has()");return this.cache.has(r)}delete(e,t){let r;if(typeof e=="string"&&t)r=`${e}|${t}`;else if(typeof e=="object")r=this.getKey(e);else throw new Error("Invalid arguments to delete()");return this.cache.delete(r)}clear(){this.cache.clear()}size(){return this.cache.size}getAll(){return Array.from(this.cache.values()).map(e=>e.article)}getStats(){const e=Date.now();let t=0,r=e,n=0;this.cache.forEach(({timestamp:h})=>{t+=e-h,h<r&&(r=h),h>n&&(n=h)});const o=this.cache.size,a=o>0?t/o:0,i=o>0?e-r:0,d=o>0?e-n:0;let c=null;return"memory"in performance&&(c=Math.round(performance.memory.usedJSHeapSize/(1024*1024))),{hits:this.stats.hits,misses:this.stats.misses,hitRate:this.stats.hits+this.stats.misses>0?this.stats.hits/(this.stats.hits+this.stats.misses):0,size:o,maxSize:this.options.maxSize,evictions:this.stats.evictions,oldestItemAge:i,newestItemAge:d,averageAge:a,memoryUsage:c}}enforceConstraints(){this.enforceMaxSize(),this.enforceMaxAge(),this.enforceMemoryLimit()}enforceMaxSize(){if(this.cache.size<=this.options.maxSize)return;const e=this.cache.size-this.options.maxSize;if(e<=0)return;const t=Array.from(this.cache.entries()).sort((r,n)=>r[1].timestamp-n[1].timestamp);for(let r=0;r<e;r++)r<t.length&&(this.cache.delete(t[r][0]),this.stats.evictions++)}enforceMaxAge(){if(this.options.maxAge<=0)return;const e=Date.now();this.cache.forEach((t,r)=>{e-t.timestamp>this.options.maxAge&&(this.cache.delete(r),this.stats.evictions++)})}enforceMemoryLimit(){if(this.options.memoryLimit<=0||!("memory"in performance))return;const t=performance.memory.usedJSHeapSize/(1024*1024);if(t<this.options.memoryLimit)return;const r=Math.max(1,Math.ceil(this.cache.size*.1)),n=Array.from(this.cache.entries()).sort((o,a)=>o[1].timestamp-a[1].timestamp);for(let o=0;o<r&&o<n.length;o++)this.cache.delete(n[o][0]),this.stats.evictions++;X.log(`Evicted ${r} articles from cache due to memory limit (${t.toFixed(2)}MB used)`)}startAutoCleanup(){this.cleanupInterval===null&&(this.cleanupInterval=window.setInterval(()=>{this.cleanup()},this.options.autoCleanupInterval),X.log(`Started automatic cache cleanup every ${this.options.autoCleanupInterval/1e3} seconds`))}stopAutoCleanup(){this.cleanupInterval!==null&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}cleanup(){this.cache.size,this.enforceMaxAge(),this.enforceMemoryLimit(),this.cache.size}resetStats(){this.stats={hits:0,misses:0,evictions:0}}}const He=new he;class ue{constructor(){this.logs=[],this.maxLogs=100,this.listeners=[],this.originalConsole={log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug},this.init()}init(){console.log=(...e)=>{this.addLog("log",e),this.originalConsole.log(...e)},console.info=(...e)=>{this.addLog("info",e),this.originalConsole.info(...e)},console.warn=(...e)=>{this.addLog("warn",e),this.originalConsole.warn(...e)},console.error=(...e)=>{this.addLog("error",e),this.originalConsole.error(...e)}}addLog(e,t){const r=t.map(o=>typeof o=="object"?JSON.stringify(o,null,2):String(o)).join(" "),n={id:Math.random().toString(36).substr(2,9),timestamp:Date.now(),type:e,message:r,data:t};this.logs=[n,...this.logs].slice(0,this.maxLogs),this.notifyListeners()}getLogs(){return this.logs}clearLogs(){this.logs=[],this.notifyListeners()}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}log(...e){this.addLog("log",e),this.originalConsole.log(...e)}info(...e){this.addLog("info",e),this.originalConsole.info(...e)}warn(...e){this.addLog("warn",e),this.originalConsole.warn(...e)}error(...e){this.addLog("error",e),this.originalConsole.error(...e)}debug(...e){this.addLog("debug",e),this.originalConsole.debug?this.originalConsole.debug(...e):this.originalConsole.log("[DEBUG]",...e)}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}}const g=new ue,ge=()=>g,Je=s=>g,H=600*1e3,J=100,V=7200*1e3,A="smart-feed-cache";class fe{constructor(e={}){this.cache=new Map,this.stats={hits:0,misses:0,sets:0,evictions:0},this.options={ttl:e.ttl||H,maxEntries:e.maxEntries||J,enablePersistence:e.enablePersistence!==!1,enableStaleWhileRevalidate:e.enableStaleWhileRevalidate||V},this.options.enablePersistence&&this.loadFromStorage(),this.setupPeriodicCleanup()}get(e){const t=this.cache.get(e);if(!t)return this.stats.misses++,null;const r=Date.now(),n=r-t.timestamp;return t.accessCount++,t.lastAccessed=r,n<=this.options.ttl?(this.stats.hits++,g.debug("Cache hit for feed (fresh)",{component:"SmartCache",additionalData:{feedUrl:e,age:Math.round(n/1e3),ttl:Math.round(this.options.ttl/1e3),articlesCount:t.articles.length}}),t.articles):n<=this.options.enableStaleWhileRevalidate?(this.stats.hits++,g.debug("Cache hit for feed (stale)",{component:"SmartCache",additionalData:{feedUrl:e,age:Math.round(n/1e3),staleLimit:Math.round(this.options.enableStaleWhileRevalidate/1e3),articlesCount:t.articles.length}}),t.articles):(this.cache.delete(e),this.stats.misses++,g.debug("Cache expired for feed",{component:"SmartCache",additionalData:{feedUrl:e,age:Math.round(n/1e3),staleLimit:Math.round(this.options.enableStaleWhileRevalidate/1e3)}}),null)}getStaleWhileRevalidate(e){const t=this.cache.get(e);if(!t)return null;const r=Date.now(),n=r-t.timestamp;return n<=this.options.enableStaleWhileRevalidate?(t.lastAccessed=r,g.debug("Serving stale content while revalidating",{component:"SmartCache",additionalData:{feedUrl:e,age:Math.round(n/1e3),articlesCount:t.articles.length}}),t.articles):null}isFresh(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp<=this.options.ttl:!1}isStale(e){const t=this.cache.get(e);if(!t)return!1;const r=Date.now()-t.timestamp;return r>this.options.ttl&&r<=this.options.enableStaleWhileRevalidate}set(e,t,r,n){const o=Date.now(),a={articles:t.map(i=>({...i,pubDate:new Date(i.pubDate)})),timestamp:o,feedUrl:e,title:r,etag:n?.get("etag")||void 0,lastModified:n?.get("last-modified")||void 0,accessCount:1,lastAccessed:o};this.cache.size>=this.options.maxEntries&&this.evictLeastRecentlyUsed(),this.cache.set(e,a),this.stats.sets++,g.debug("Cached articles for feed",{component:"SmartCache",additionalData:{feedUrl:e,articlesCount:t.length,title:r,hasEtag:!!a.etag,hasLastModified:!!a.lastModified,cacheSize:this.cache.size}}),this.options.enablePersistence&&this.persistToStorage()}delete(e){const t=this.cache.delete(e);return t&&(g.debug("Removed cache entry for feed",{component:"SmartCache",additionalData:{feedUrl:e}}),this.options.enablePersistence&&this.persistToStorage()),t}clear(){const e=this.cache.size;this.cache.clear(),g.info("Cleared all cache entries",{component:"SmartCache",additionalData:{clearedEntries:e}}),this.options.enablePersistence&&this.persistToStorage()}getStats(){const e=Array.from(this.cache.values()),t=e.reduce((o,a)=>o+a.articles.length,0),r=e.map(o=>o.timestamp),n=this.stats.hits+this.stats.misses>0?this.stats.hits/(this.stats.hits+this.stats.misses):0;return{totalEntries:this.cache.size,totalArticles:t,cacheSize:this.estimateCacheSize(),hitRate:n,oldestEntry:r.length>0?Math.min(...r):0,newestEntry:r.length>0?Math.max(...r):0}}getKeys(){return Array.from(this.cache.keys())}has(e){return this.cache.has(e)}getMetadata(e){const t=this.cache.get(e);if(!t)return null;const{articles:r,...n}=t;return n}cleanup(){const e=Date.now(),t=[];for(const[r,n]of this.cache.entries())e-n.timestamp>this.options.enableStaleWhileRevalidate&&t.push(r);return t.forEach(r=>this.cache.delete(r)),t.length>0&&(g.info("Cleaned up expired cache entries",{component:"SmartCache",additionalData:{expiredCount:t.length,remainingCount:this.cache.size}}),this.options.enablePersistence&&this.persistToStorage()),t.length}evictLeastRecentlyUsed(){let e=null,t=Date.now();for(const[r,n]of this.cache.entries())n.lastAccessed<t&&(t=n.lastAccessed,e=r);e&&(this.cache.delete(e),this.stats.evictions++,g.debug("Evicted LRU cache entry",{component:"SmartCache",additionalData:{evictedKey:e,lastAccessed:new Date(t).toISOString()}}))}estimateCacheSize(){let e=0;for(const t of this.cache.values())e+=JSON.stringify(t).length*2;return e}loadFromStorage(){try{const e=localStorage.getItem(A);if(!e)return;const t=JSON.parse(e),r=Date.now();for(const[n,o]of t.entries||[]){const a={...o,articles:o.articles.map(d=>({...d,pubDate:new Date(d.pubDate)}))};r-a.timestamp<=this.options.enableStaleWhileRevalidate&&this.cache.set(n,a)}g.info("Loaded cache from storage",{component:"SmartCache",additionalData:{loadedEntries:this.cache.size,totalStored:t.entries?.length||0}})}catch(e){g.error("Failed to load cache from storage",e,{component:"SmartCache"}),localStorage.removeItem(A)}}persistToStorage(){try{const e=Array.from(this.cache.entries()).map(([r,n])=>[r,{...n,articles:n.articles.map(o=>({...o,pubDate:o.pubDate.toISOString()}))}]),t={entries:e,timestamp:Date.now(),version:"1.0.0"};localStorage.setItem(A,JSON.stringify(t)),g.debug("Persisted cache to storage",{component:"SmartCache",additionalData:{entriesCount:e.length,estimatedSize:JSON.stringify(t).length}})}catch(e){g.error("Failed to persist cache to storage",e,{component:"SmartCache",additionalData:{cacheSize:this.cache.size,estimatedSize:this.estimateCacheSize()}})}}setupPeriodicCleanup(){setInterval(()=>{this.cleanup()},300*1e3)}}const M=new fe({ttl:H,maxEntries:J,enablePersistence:!0,enableStaleWhileRevalidate:V}),pe=s=>M.get(s),ye=(s,e,t,r)=>{M.set(s,e,t,r)},Ve=s=>M.isFresh(s),K={maxXmlSize:10*1024*1024,allowedRootElements:["rss","feed","rdf:rdf","rdf"],blockedPatterns:[/<!ENTITY[^>]*SYSTEM/i,/<!ENTITY[^>]*PUBLIC/i,/javascript:/gi,/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,/on\w+\s*=\s*["'][^"']*["']/gi,/data:text\/html/gi,/vbscript:/gi,/expression\s*\(/gi]};function G(s,e){if(s.length>e.maxXmlSize)throw new Error(`XML size exceeds security limit of ${e.maxXmlSize} bytes`);for(const t of e.blockedPatterns)if(t.test(s))throw new Error("Potentially malicious XML content detected: blocked pattern found")}function be(s,e){const t=s.documentElement;if(!t)throw new Error("No valid XML root element found");const r=t.tagName.toLowerCase();if(!e.allowedRootElements.some(o=>r===o.toLowerCase()))throw new Error(`Root element '${r}' is not in allowed list: ${e.allowedRootElements.join(", ")}`);const n=Array.from(s.childNodes).filter(o=>o.nodeType===Node.ELEMENT_NODE);if(n.length>1)throw new Error(`XML contains ${n.length} root nodes, but only 1 is allowed`)}function N(s){if(!s)return"";let e=s;return e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&apos;/g,"'"),e=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/on\w+\s*=\s*["'][^"']*["']/gi,"").replace(/javascript:/gi,"").replace(/vbscript:/gi,"").replace(/data:text\/html/gi,"").replace(/expression\s*\(/gi,"").replace(/<[^>]*>/g,""),e=e.replace(/&nbsp;/g," ").replace(/&amp;/g,"&").trim(),e}function we(s,e){if(!s)return"";const r=s.querySelector(e)?.textContent||"";return N(r)}function Ee(s,e){if(!s)return"";const t=s.getAttribute(e)||"";return N(t)}function Se(s,e=K){try{if(!s||typeof s!="string")throw new Error("Invalid XML input: must be a non-empty string");const t=s.trim();if(!t)throw new Error("Invalid XML input: must be a non-empty string");G(t,e);const n=new DOMParser().parseFromString(t,"application/xml"),o=n.querySelector("parsererror");if(o)throw new Error(`XML parsing error: ${o.textContent}`);return be(n,e),n}catch(t){throw console.error("Secure XML parsing error:",t),new Error(`Failed to parse XML securely: ${t instanceof Error?t.message:"Unknown error"}`)}}function xe(s){const e={...K,allowedRootElements:["rss","feed","rdf:rdf","rdf"]};return Se(s,e)}const $={getSecureTextContent:we,getSecureAttributeValue:Ee,sanitizeTextContent:N,validateXmlSecurity:G},Te=[{original:"http://feeds.feedburner.com/tecnoblog",alternatives:["https://tecnoblog.net/feed/","https://tecnoblog.net/rss/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/Techcrunch",alternatives:["https://techcrunch.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/blogdoiphone/rss",alternatives:["https://blogdoiphone.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://macmagazine.com.br/feed/",alternatives:["https://macmagazine.com.br/feed/"],notes:"HTTP to HTTPS redirect"},{original:"http://feeds2.feedburner.com/canaltechbr",alternatives:["https://canaltech.com.br/rss/","https://canaltech.com.br/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/guiadopc",alternatives:["https://guiadopc.com.br/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://meiobit.com/index.xml",alternatives:["https://meiobit.com/feed/","https://meiobit.com/index.xml"],notes:"HTTP to HTTPS redirect"},{original:"http://feeds.feedburner.com/design-milk",alternatives:["https://design-milk.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/core77/blog",alternatives:["https://www.core77.com/rss/object.xml"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/dezeen",alternatives:["https://www.dezeen.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/JustCreativeDesignBlog",alternatives:["https://justcreative.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds2.feedburner.com/thenextweb",alternatives:["https://thenextweb.com/feed/"],notes:"FeedBurner redirect to direct feed"},{original:"http://feeds.feedburner.com/brainstorm9",alternatives:["https://www.brainstorm9.com/feed/"],notes:"FeedBurner redirect to direct feed"}];function ve(s){const e=[s],t=Te.find(r=>r.original===s);if(t&&e.push(...t.alternatives),s.startsWith("http://")){const r=s.replace("http://","https://");e.includes(r)||e.push(r)}return[...new Set(e)]}const Ce=8e3,Fe=2,De=500,y=ge(),Ae=[{name:"RSS2JSON",url:"https://api.rss2json.com/v1/api.json",format:s=>`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(s)}`,parser:Me},{name:"AllOrigins",url:"https://api.allorigins.win/raw",format:s=>`https://api.allorigins.win/raw?url=${encodeURIComponent(s)}`,parser:R},{name:"CodeTabs",url:"https://api.codetabs.com/v1/proxy",format:s=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(s)}`,parser:R},{name:"CORSProxy",url:"https://corsproxy.io",format:s=>`https://corsproxy.io/?${encodeURIComponent(s)}`,parser:R}];class Re{constructor(){this.failures=new Map,this.threshold=3,this.timeout=6e4}isOpen(e){const t=this.failures.get(e);return t?Date.now()-t.lastAttempt>this.timeout?(this.failures.delete(e),!1):t.count>=this.threshold:!1}recordFailure(e){const t=this.failures.get(e)||{count:0,lastAttempt:0};t.count++,t.lastAttempt=Date.now(),this.failures.set(e,t)}recordSuccess(e){this.failures.delete(e)}}const I=new Re;function Y(s){return $.sanitizeTextContent(s)}function x(s){return $.sanitizeTextContent(s)}function q(s){return $.sanitizeTextContent(s)}async function Ie(s,e={}){const{timeout:t=Ce,...r}=e,n=new AbortController,o=setTimeout(()=>n.abort(),t);try{const a=await fetch(s,{...r,signal:n.signal,headers:{Accept:"application/rss+xml, application/xml, application/atom+xml, text/xml, application/json, */*",...r.headers}});return clearTimeout(o),a}catch(a){throw clearTimeout(o),a instanceof Error&&a.name==="AbortError"?new Error(`Request timeout after ${t}ms`):a}}function Me(s,e){const t=JSON.parse(s);if(t.status==="error")throw new Error(`RSS2JSON error: ${t.message||"Unknown error"}`);if(t.status!=="ok"||!t.items)throw new Error("Invalid RSS2JSON response format");const r=t.items.map(n=>{let o=n.thumbnail||n.enclosure?.link;if(o)try{new URL(o).protocol.startsWith("http")||(o=void 0),o&&(o.includes("?text=")||o.match(/^[A-Z0-9]{6}\?text=/i)||!o.includes("."))&&(o=void 0)}catch{o=void 0}return{title:n.title?x(n.title):"No Title",link:n.link||e,pubDate:n.pubDate?new Date(n.pubDate):new Date,description:n.description?Y(n.description).substring(0,200):"",sourceTitle:t.feed?.title?x(t.feed.title):"RSS Feed",author:n.author?q(n.author):void 0,categories:n.categories||[],imageUrl:o||void 0}});return{title:t.feed?.title||"RSS Feed",articles:r}}function R(s,e){const t=xe(s),r=t.getElementsByTagName("parsererror");if(r.length>0)throw new Error(`XML parsing error: ${r[0].textContent}`);let n="Untitled Feed",o;const a=t.getElementsByTagName("channel");if(a.length>0)n=a[0].getElementsByTagName("title")[0]?.textContent?.trim()||"Untitled Feed",n=x(n),o=t.getElementsByTagName("item");else{const d=t.getElementsByTagName("feed");if(d.length>0)n=d[0].getElementsByTagName("title")[0]?.textContent?.trim()||"Untitled Feed",n=x(n),o=t.getElementsByTagName("entry");else{const c=t.getElementsByTagName("item");if(c.length>0){const h=t.getElementsByTagName("channel");h.length>0&&(n=h[0].getElementsByTagName("title")[0]?.textContent?.trim()||"Untitled Feed",n=x(n)),o=c}else throw new Error("Unsupported RSS format")}}const i=[];for(let d=0;d<Math.min(o.length,50);d++){const c=o[d];try{const u=c.getElementsByTagName("title")[0]?.textContent?.trim()||"No Title",b=x(u);let E="";const D=c.getElementsByTagName("link");D.length>0&&(E=D[0].textContent?.trim()||D[0].getAttribute("href")||"");let L=new Date;const Z=c.getElementsByTagName("pubDate"),Q=c.getElementsByTagName("published"),ee=c.getElementsByTagName("date"),P=Z[0]||Q[0]||ee[0];if(P?.textContent){const m=new Date(P.textContent.trim());isNaN(m.getTime())||(L=m)}let z="";const te=c.getElementsByTagName("description"),se=c.getElementsByTagName("summary"),re=c.getElementsByTagName("content"),T=te[0]||se[0]||re[0];T?.textContent&&(z=Y(T.textContent).substring(0,200));let B="";const ne=c.getElementsByTagName("author"),oe=c.getElementsByTagName("creator"),U=ne[0]||oe[0];if(U?.textContent){const m=U.textContent.trim();B=q(m)}const k=[],j=c.getElementsByTagName("category");for(let m=0;m<j.length;m++){const p=j[m].textContent?.trim();p&&k.push(p)}let f="";const W=c.getElementsByTagName("enclosure");for(let m=0;m<W.length;m++){const p=W[m],w=p.getAttribute("type");if(w&&w.startsWith("image/")){f=p.getAttribute("url")||"";break}}if(!f){const m=c.getElementsByTagName("media:content");for(let p=0;p<m.length;p++){const w=m[p],S=w.getAttribute("type");if(S&&S.startsWith("image/")){f=w.getAttribute("url")||"";break}}}if(!f){const m=c.getElementsByTagName("media:thumbnail");m.length>0&&(f=m[0].getAttribute("url")||"")}if(!f&&T){const m=T.innerHTML||T.textContent||"",p=[/<img[^>]+src=["']([^"']+)["'][^>]*>/i,/src=["']([^"']+\.(?:jpg|jpeg|png|gif|webp|svg))[^"']*/i,/https?:\/\/[^\s<>"]+\.(?:jpg|jpeg|png|gif|webp|svg)/i];for(const w of p){const S=m.match(w);if(S&&S[1]){f=S[1];break}}}let _;if(f)try{const m=new URL(f);(m.protocol==="http:"||m.protocol==="https:")&&!f.includes("?text=")&&!f.match(/^[A-Z0-9]{6}\?text=/i)&&f.includes(".")&&(_=f)}catch{y.debug(`Invalid image URL filtered: ${f}`,{component:"rssParser"})}b!=="No Title"&&E&&i.push({title:b,link:E,pubDate:L,description:z,imageUrl:_,author:B||void 0,categories:k,sourceTitle:n})}catch(h){y.warn(`Failed to parse article ${d+1}`,{component:"rssParser",additionalData:{error:h instanceof Error?h.message:String(h)}})}}return{title:n,articles:i}}function Ne(s){if(!s||s.trim().length===0)return!1;const e=s.trim();return e.toLowerCase().includes("<!doctype html")||e.toLowerCase().startsWith("<html")?!1:e.startsWith("<")||e.startsWith("{")}async function $e(s,e,t){if(I.isOpen(s.name))throw new Error(`Circuit breaker open for ${s.name}`);const r=s.format(e);y.debug(`Trying provider: ${s.name}`,{component:"rssParser",additionalData:{feedUrl:e,proxyUrl:r}});const n=await Ie(r,{signal:t});if(!n.ok)throw n.status===422?new Error(`Provider ${s.name} cannot process this feed (422 Unprocessable Entity)`):new Error(`Provider ${s.name} returned ${n.status}: ${n.statusText}`);const o=await n.text();if(!Ne(o))throw new Error(`Invalid response from ${s.name}`);const a=s.parser(o,e);if(!a.articles||a.articles.length===0)throw new Error(`No articles parsed from ${s.name}`);return I.recordSuccess(s.name),y.info(`Successfully fetched via ${s.name}`,{component:"rssParser",additionalData:{feedUrl:e,provider:s.name,articlesCount:a.articles.length}}),a}async function Le(s,e){const t=ve(s);let r=new Error("Unknown error");for(const n of t)for(const o of Ae)try{return await $e(o,n,e)}catch(a){r=a instanceof Error?a:new Error(String(a)),I.recordFailure(o.name),y.debug(`Provider ${o.name} failed for ${n}`,{component:"rssParser",additionalData:{error:r.message}})}throw new Error(`All providers failed. Last error: ${r.message}`)}function Pe(s){return new Promise(e=>setTimeout(e,s))}async function ze(s,e={}){const{maxRetries:t=Fe,signal:r}=e;let n=new Error("Unknown error");for(let o=1;o<=t;o++)try{y.debug(`Fetching feed (attempt ${o}/${t})`,{component:"rssParser",additionalData:{feedUrl:s}});const a=await Le(s,r);return a.articles.length>0&&ye(s,a.articles,a.title),y.info(`Successfully fetched feed on attempt ${o}`,{component:"rssParser",additionalData:{feedUrl:s,articlesCount:a.articles.length,attempt:o}}),a}catch(a){if(n=a instanceof Error?a:new Error(String(a)),r?.aborted)throw new Error("Request was cancelled");if(o===t)break;const i=De*Math.pow(2,o-1);y.warn(`Attempt ${o} failed, retrying in ${i}ms`,{component:"rssParser",additionalData:{feedUrl:s,error:n.message}}),await Pe(i)}throw y.error(`All ${t} attempts failed`,n,{component:"rssParser",additionalData:{feedUrl:s}}),n}async function Ke(s,e={}){const{skipCache:t=!1}=e;if(!t){const r=pe(s);if(r&&r.length>0)return y.debug("Using cached articles",{component:"rssParser",additionalData:{feedUrl:s,cachedCount:r.length}}),{title:r[0].sourceTitle,articles:r}}try{return await ze(s,e)}catch(r){return y.warn("Creating placeholder for failed feed",{component:"rssParser",additionalData:{url:s,error:r instanceof Error?r.message:String(r)}}),{title:"Feed Unavailable",articles:[{title:"RSS Feed Temporarily Unavailable",link:s,pubDate:new Date,description:"Unable to fetch this RSS feed. This may be due to CORS restrictions or temporary server issues. The feed will be retried automatically.",sourceTitle:"System Notice",categories:["system","unavailable"]}]}}}function Ge(s){const t=new DOMParser().parseFromString(s,"text/xml"),r=[],n=(a,i)=>{const d=a.getAttribute("xmlUrl"),c=a.getAttribute("text")||a.getAttribute("title");if(d)r.push({url:d,title:c||void 0,category:i});else if(a.children.length>0){const h=c||i;for(let u=0;u<a.children.length;u++){const b=a.children[u];b.tagName.toLowerCase()==="outline"&&n(b,h)}}},o=t.getElementsByTagName("body")[0];if(o)for(let a=0;a<o.children.length;a++){const i=o.children[a];i.tagName.toLowerCase()==="outline"&&n(i)}return r}export{He as a,Be as b,Xe as c,_e as d,F as e,je as f,Oe as g,ke as h,pe as i,Ke as j,Ve as k,g as l,We as m,Ge as p,Ue as s,Je as u,le as v};
