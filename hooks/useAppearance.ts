import { useCallback } from 'react';
import { useLocalStorage } from './useLocalStorage';
import type { HeaderConfig, ContentConfig, LayoutPreset, BackgroundConfig } from '../types';
import { useExtendedTheme } from './useExtendedTheme';
import { DEFAULT_CONFIG } from '../services/auraWallpaperService'; // Import DEFAULT_CONFIG

const defaultHeaderConfig: HeaderConfig = {
  style: 'default',
  position: 'sticky',
  height: 'normal',
  showTitle: true,
  showLogo: true,
  customTitle: 'Personal News',
  logoUrl: null,
  logoSize: 'md',
  // Appearance defaults
  backgroundColor: '#0a0a0c',
  backgroundOpacity: 95,
  blurIntensity: 'medium',
  borderColor: '#ffffff',
  borderOpacity: 8,
  categoryBackgroundColor: '#ffffff',
  categoryBackgroundOpacity: 3,
};

const defaultContentConfig: ContentConfig = {
  showAuthor: true,
  showDate: true,
  showTime: false,
  showTags: true,
  layoutMode: 'default',
  density: 'comfortable',
  paginationType: 'numbered',
};

const defaultBackgroundConfig: BackgroundConfig = {
  type: 'aura',
  value: '', // Will be generated by BackgroundCreator
  auraSettings: DEFAULT_CONFIG,
};

export const LAYOUT_PRESETS: LayoutPreset[] = [
  {
    id: 'magazine',
    name: 'Magazine',
    description: 'Layout clássico com header sólido e navegação central.',
    header: { 
      style: 'centered', 
      position: 'sticky', 
      height: 'normal', 
      showTitle: true, 
      showLogo: true,
      backgroundColor: '#1a1a1a', 
      backgroundOpacity: 98,
      blurIntensity: 'medium',
      borderColor: '#ffffff',
      borderOpacity: 10
    },
    content: { layoutMode: 'magazine', density: 'comfortable', showAuthor: true, showDate: true, showTags: true }
  },
  {
    id: 'newspaper',
    name: 'Newspaper',
    description: 'Estilo jornal clássico, denso e informativo.',
    header: { 
      style: 'default', 
      position: 'static', 
      height: 'spacious', 
      showTitle: true, 
      showLogo: true,
      backgroundColor: '#111827',
      backgroundOpacity: 100,
      blurIntensity: 'none',
      borderColor: '#374151',
      borderOpacity: 25
    },
    content: { layoutMode: 'newspaper', density: 'compact', showAuthor: true, showDate: true, showTags: false }
  },
  {
    id: 'minimal',
    name: 'Minimal',
    description: 'Foco no conteúdo. Header flutuante transparente.',
    header: { 
      style: 'minimal', 
      position: 'floating', 
      height: 'compact', 
      showTitle: false, 
      showLogo: true,
      backgroundColor: '#000000',
      backgroundOpacity: 40,
      blurIntensity: 'heavy',
      borderColor: 'transparent',
      borderOpacity: 0
    },
    content: { layoutMode: 'minimal', density: 'spacious', showAuthor: true, showDate: false, showTags: false }
  },
  {
    id: 'focus',
    name: 'Focus',
    description: 'Leitura sem distrações. Header oculto e layout de coluna única.',
    header: { 
      style: 'minimal', 
      position: 'hidden', 
      height: 'compact', 
      showTitle: false, 
      showLogo: false, // Hidden header usually hides everything anyway, but configured just in case
      blurIntensity: 'none'
    },
    content: { layoutMode: 'focus', density: 'comfortable', showAuthor: true, showDate: true, showTags: true }
  },
  {
    id: 'immersive',
    name: 'Immersive',
    description: 'Experiência full-screen com header ultra-discreto.',
    header: { 
      style: 'minimal', 
      position: 'floating', 
      height: 'normal', 
      showTitle: false, 
      showLogo: true,
      backgroundColor: '#000000',
      backgroundOpacity: 0, // Fully transparent
      blurIntensity: 'none',
      borderColor: 'transparent'
    },
    content: { layoutMode: 'immersive', density: 'spacious', showAuthor: true, showDate: true, showTags: false }
  },
  {
    id: 'brutalist',
    name: 'Brutalist',
    description: 'Bordas fortes, alto contraste e tipografia marcante.',
    header: { 
      style: 'default', 
      position: 'static', 
      height: 'spacious', 
      showTitle: true, 
      showLogo: false, // Only Title
      backgroundColor: '#000000',
      backgroundOpacity: 100,
      blurIntensity: 'none',
      borderColor: '#ffffff',
      borderOpacity: 100 // Solid border
    },
    content: { layoutMode: 'brutalist', density: 'spacious', showAuthor: true, showDate: true, showTags: true }
  },
  {
    id: 'timeline',
    name: 'Timeline',
    description: 'Navegação por tempo. Header sticky compacto.',
    header: { 
      style: 'default', 
      position: 'sticky', 
      height: 'compact', 
      showTitle: true, 
      showLogo: true,
      backgroundColor: '#1f2937', 
      backgroundOpacity: 90, 
      blurIntensity: 'light',
      borderColor: '#374151',
      borderOpacity: 50
    },
    content: { layoutMode: 'timeline', density: 'comfortable', showAuthor: true, showDate: true, showTags: true }
  },
  {
    id: 'bento',
    name: 'Bento Grid',
    description: 'Layout modular moderno.',
    header: { 
      style: 'centered', 
      position: 'floating', 
      height: 'normal', 
      showTitle: false, 
      showLogo: true,
      backgroundColor: '#1a1a1a', 
      backgroundOpacity: 60, 
      blurIntensity: 'heavy',
      borderColor: '#ffffff',
      borderOpacity: 5
    },
    content: { layoutMode: 'bento', density: 'compact', showAuthor: false, showDate: true, showTags: false }
  }
];

export const useAppearance = () => {
  const { themeSettings, updateThemeSettings, currentTheme, customThemes, defaultPresets, setCurrentTheme, removeCustomTheme } = useExtendedTheme();

  const [headerConfig, setHeaderConfig] = useLocalStorage<HeaderConfig>(
    'appearance-header',
    defaultHeaderConfig
  );

  const [contentConfig, setContentConfig] = useLocalStorage<ContentConfig>(
    'appearance-content',
    defaultContentConfig
  );

  const [backgroundConfig, setBackgroundConfig] = useLocalStorage<BackgroundConfig>(
    'appearance-background',
    defaultBackgroundConfig
  );

  const [activeLayoutId, setActiveLayoutId] = useLocalStorage<string | null>(
    'appearance-active-layout',
    null
  );

  const updateHeaderConfig = useCallback((updates: Partial<HeaderConfig>) => {
    setHeaderConfig((prev) => ({ ...prev, ...updates }));
    setActiveLayoutId(null);
  }, [setHeaderConfig, setActiveLayoutId]);

  const updateContentConfig = useCallback((updates: Partial<ContentConfig>) => {
    setContentConfig((prev) => ({ ...prev, ...updates }));
    setActiveLayoutId(null);
  }, [setContentConfig, setActiveLayoutId]);

  const updateBackgroundConfig = useCallback((updates: Partial<BackgroundConfig>) => {
    setBackgroundConfig((prev) => ({ ...prev, ...updates }));
  }, [setBackgroundConfig]);

  const applyLayoutPreset = useCallback((presetId: string) => {
    const preset = LAYOUT_PRESETS.find(p => p.id === presetId);
    if (preset) {
      setHeaderConfig(prev => ({ ...prev, ...preset.header }));
      setContentConfig(prev => ({ ...prev, ...preset.content }));
      setActiveLayoutId(presetId);
    }
  }, [setHeaderConfig, setContentConfig, setActiveLayoutId]);

  const resetAppearance = useCallback(() => {
    setHeaderConfig(defaultHeaderConfig);
    setContentConfig(defaultContentConfig);
    setBackgroundConfig(defaultBackgroundConfig);
    setActiveLayoutId(null);
  }, [setHeaderConfig, setContentConfig, setBackgroundConfig, setActiveLayoutId]);

  return {
    headerConfig,
    contentConfig,
    backgroundConfig,
    activeLayoutId,
    updateHeaderConfig,
    updateContentConfig,
    updateBackgroundConfig,
    applyLayoutPreset,
    resetAppearance,
    themeSettings,
    updateThemeSettings,
    currentTheme,
    customThemes,
    defaultPresets,
    setCurrentTheme,
    removeCustomTheme,
  };
};
